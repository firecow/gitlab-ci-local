---
name: build
on:
  push:
    tags-ignore:
      - '**'
    branches:
      - master
  pull_request:

jobs:

  yamllint:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: ibiqlik/action-yamllint@v3.1.1
        with:
          strict: true

  smoke-test:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: oven-sh/setup-bun@v2.1.2
        with:
          bun-version: 1.3.9
      - uses: actions/setup-node@v6
      - run: bun install --frozen-lockfile
      - run: bun run build:linux-amd64
      - run: bin/linux-amd64/gitlab-ci-local --version
      - run: bin/linux-amd64/gitlab-ci-local --help
      - run: bun run build:node
      - run: node dist/index.js --version
      - run: node dist/index.js --help
      - run: head -1 dist/index.js | grep -q '#!/usr/bin/env node'

  eslint:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: oven-sh/setup-bun@v2.1.2
        with:
          bun-version: 1.3.9
      - run: bun install --frozen-lockfile
      - run: bun run lint

  unused-deps:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: oven-sh/setup-bun@v2.1.2
        with:
          bun-version: 1.3.9
      - run: bun install --frozen-lockfile
      - run: bunx depcheck --ignores depcheck,@types/bun,@types/bun-types,bun:test

  test:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0
      - uses: oven-sh/setup-bun@v2.1.2
        with:
          bun-version: 1.3.9
      - run: bun install --frozen-lockfile
      - name: Run Tests
        run: bun run coverage
      - uses: sonarsource/sonarqube-scan-action@v7.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        if: ${{ env.SONAR_TOKEN != '' }}

  code-ql:
    name: CodeQL
    runs-on: ubuntu-24.04
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4.32.3
        with:
          languages: 'typescript'

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4.32.3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4.32.3
