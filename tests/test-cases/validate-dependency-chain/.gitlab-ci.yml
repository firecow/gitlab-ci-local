---
stages:
    - build
    - test

alpine-guest:
    image: nginxinc/nginx-unprivileged:alpine3.18
    needs: ["alpine-root"]
    script:
        - stat -c "%a %n %u %g" one.txt
        - stat -c "%a %n %u %g" script.sh
    rules:
        - if: '$RUN_ALL == "true"'
        - if: '$RUN_SINGLE == "alpine-root"'
        - if: '$RUN_SINGLE == "alpine-guest"'

alpine-root:
    needs: ["kaniko-root"]
    image: nginx:alpine3.18
    rules:
        - if: '$RUN_ALL == "true"'
        - if: '$RUN_SINGLE == "alpine-root"'
        - if: '$RUN_SINGLE == "alpine-guest"'
          when: never
    script:
        - stat -c "%a %n %u %g" one.txt
        - stat -c "%a %n %u %g" script.sh

kaniko-root:
    image:
        name: gcr.io/kaniko-project/executor:v1.23.0-debug
        entrypoint: [""]
    rules:
        - if: '$RUN_ALL == "true"'
    script:
        - stat -c "%a %n %u %g" one.txt
        - stat -c "%a %n %u %g" script.sh


kaniko-guest:
    image:
        name: gcr.io/kaniko-project/executor:v1.23.0-debug
        entrypoint: [""]
    rules:
        - if: '$RUN_ALL == "true"'
    script:
        - stat -c "%a %n %u %g" one.txt
        - stat -c "%a %n %u %g" script.sh


build-job-1:
    stage: build
    script: echo "build 1"
    artifacts:
        paths: [build1.txt]
    rules:
        - if: '$RUN_ALL == "true"'
        - if: '$TEST_DEPENDENCIES == "true"'


test-job:
    stage: test
    dependencies: [build-job-1]
    rules:
        - if: '$RUN_ALL == "true"'
    script: echo "testing"

build-job-2:
    stage: build
    script: echo "build 2"
    artifacts:
        paths: [build2.txt]
    rules:
        - if: '$RUN_ALL == "true"'

broken-dependencies-job:
    stage: test
    dependencies: [build-job-1, build-job-2]
    rules:
        - if: '$TEST_DEPENDENCIES == "true"'
    script: echo "This has broken dependencies"
